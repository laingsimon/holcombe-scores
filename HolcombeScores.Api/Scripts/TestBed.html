<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Holcombe Scores Script Testbed</title>
</head>
<body>
<script src="/api/Client/"></script>
<link rel="stylesheet" href="https://unpkg.com/jest-lite@1.0.0-alpha.4/dist/prettify.css"/>
<script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/jest-lite@1.0.0-alpha.4/dist/core.js"></script>
<script crossorigin src="https://unpkg.com/jest-lite@1.0.0-alpha.4/dist/enzyme.js"></script>
<script crossorigin src="https://unpkg.com/jest-lite@1.0.0-alpha.4/dist/prettify.js"></script>
<script>
    class MockHttp extends Http {
        sentRequests = [];
        sequentialResponses = [];

        constructor(settings) {
            super(settings);
        }

        // override
        send(httpMethod, relativeUrl, content) {
            this.sentRequests.push({
                httpMethod: httpMethod,
                relativeUrl: relativeUrl,
                content: content
            });

            return this.sequentialResponses.shift() || new Promise(resolve => resolve(null));
        }

        lastRequest() {
            return this.sentRequests.length > 0
                ? this.sentRequests[this.sentRequests.length - 1]
                : null;
        }

        enqueueResponse(content) {
            this.sequentialResponses.push(new Promise(resolve => resolve(content)));
        }
    }

    const {
        core: {describe, it, expect, run, beforeEach},
        prettify,
    } = window.jestLite;

    let holcombeScores = new HolcombeScores();

    describe('settings', () => {
        beforeEach(() => {
            holcombeScores.api.http = new MockHttp();
        });

        it('apiHost', () => {
            expect(holcombeScores.settings.apiHost).not.toBeNull();
        });
    });

    describe('api.Access', () => {
        let sut = holcombeScores.api.access;

        beforeEach(() => {
            holcombeScores.api.http = new MockHttp(holcombeScores.api.settings);
        });

        it('getAllAccess', async () => {
            let expectedAccess = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                granted: '2022-04-26T07:25:46.467Z',
                revoked: '2022-04-26T07:25:46.467Z',
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                admin: true,
                name: 'string',
                revokedReason: 'string'
            };
            holcombeScores.api.http.enqueueResponse([expectedAccess]);

            await sut.getAllAccess()
                .then(accessList => {
                    expect(accessList).not.toBeNull();
                    expect(accessList.length).toBe(1);
                    let singleAccess = accessList[0];
                    expect(singleAccess).toBe(expectedAccess);
                });
        });

        it('deleteAccess', async () => {
            let expectedUserId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            await sut.deleteAccess(expectedUserId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Access/${expectedUserId}`);
                    expect(request.content).toBeNull();
                });
        });

        it('updateAccess', async () => {
            let expectedAccessUpdate = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                admin: true,
                name: 'string'
            };
            await sut.updateAccess(expectedAccessUpdate.teamId, expectedAccessUpdate.userId, expectedAccessUpdate.name, expectedAccessUpdate.admin)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('PATCH');
                    expect(request.relativeUrl).toBe(`/api/Access`);
                    expect(request.content).toMatchObject(expectedAccessUpdate);
                });
        });

        it('getMyAccess', async () => {
            let expectedResponse = {
                access: {
                    teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                    granted: '2022-04-26T08:01:09.918Z',
                    revoked: '2022-04-26T08:01:09.918Z',
                    userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                    admin: true,
                    name: 'string',
                    revokedReason: 'string'
                },
                request: {
                    userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                    name: 'string',
                    teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                    requested: '2022-04-26T08:01:09.919Z'
                }
            };
            holcombeScores.api.http.enqueueResponse(expectedResponse);

            await sut.getMyAccess()
                .then(response => {
                    let lastRequest = holcombeScores.api.http.lastRequest();
                    expect(lastRequest.httpMethod).toBe('GET');
                    expect(lastRequest.relativeUrl).toBe(`/api/My/Access`);
                    expect(lastRequest.content).toBeNull();
                    expect(response).toBe(expectedResponse);
                });
        });

        it('getAccessForRecovery', async () => {
            let expectedRecovery = {
                recoveryId: '5e0f9f71',
                name: 'Simon',
                type: 'Access'
            };
            holcombeScores.api.http.enqueueResponse([expectedRecovery]);

            await sut.getAccessForRecovery()
                .then(recoveryList => {
                    let lastRequest = holcombeScores.api.http.lastRequest();
                    expect(lastRequest.httpMethod).toBe('GET');
                    expect(lastRequest.relativeUrl).toBe(`/api/Access/Recover`);
                    expect(lastRequest.content).toBeNull();
                    expect(recoveryList).not.toBeNull();
                    expect(recoveryList.length).toBe(1);
                    let recovery = recoveryList[0];
                    expect(recovery).toBe(expectedRecovery);
                });
        });

        it('recoverAccess', async () => {
            let expectedAccessToRecover = {
                recoveryId: 'string',
                adminPassCode: 'string'
            };
            await sut.recoverAccess(expectedAccessToRecover.recoveryId, expectedAccessToRecover.adminPassCode)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Access/Recover`);
                    expect(request.content).toMatchObject(expectedAccessToRecover);
                });
        });

        it('createAccessRequest', async () => {
            let expectedAccessRequest = {
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                name: 'string',
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.createAccessRequest(expectedAccessRequest.userId, expectedAccessRequest.name, expectedAccessRequest.teamId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Access/Request`);
                    expect(request.content).toMatchObject(expectedAccessRequest);
                });
        });

        it('deleteAccessRequest', async () => {
            let expectedUserId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            await sut.deleteAccessRequest(expectedUserId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Access/Request/${expectedUserId}`);
                    expect(request.content).toBeNull();
                });
        });

        it('getAllAccessRequests', async () => {
            let expectedAccessRequest = {
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                name: 'string',
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                requested: '2022-04-26T07:58:18.014Z'
            };
            holcombeScores.api.http.enqueueResponse([expectedAccessRequest]);

            await sut.getAllAccessRequests()
                .then(accessRequestList => {
                    let lastRequest = holcombeScores.api.http.lastRequest();
                    expect(lastRequest.httpMethod).toBe('GET');
                    expect(lastRequest.relativeUrl).toBe(`/api/Access/Request`);
                    expect(lastRequest.content).toBeNull();
                    expect(accessRequestList).not.toBeNull();
                    expect(accessRequestList.length).toBe(1);
                    let accessRequest = accessRequestList[0];
                    expect(accessRequest).toBe(expectedAccessRequest);
                });
        });

        it('respondToAccessRequest', async () => {
            let expectedAccessResponse = {
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                allow: true,
                reason: 'string',
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.respondToAccessRequest(expectedAccessResponse.userId, expectedAccessResponse.teamId, expectedAccessResponse.reason, expectedAccessResponse.allow)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Access/Respond`);
                    expect(request.content).toMatchObject(expectedAccessResponse);
                });
        });

        it('revokeAccess', async () => {
            let expectedAccessResponse = {
                userId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                reason: 'string',
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.revokeAccess(expectedAccessResponse.userId, expectedAccessResponse.teamId, expectedAccessResponse.reason)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Access/Revoke`);
                    expect(request.content).toMatchObject(expectedAccessResponse);
                });
        });
    });

    describe('api.Game', () => {
        let sut = holcombeScores.api.game;

        beforeEach(() => {
            holcombeScores.api.http = new MockHttp(holcombeScores.api.settings);
        });

        it('getAllGames', async () => {
            let expectedGame = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                id: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                opponent: 'string',
                playingAtHome: true,
                date: '2022-04-26T11:43:33.171Z',
                squad: [
                    {
                        name: 'string',
                        number: 0,
                        teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                    }
                ],
                goals: [
                    {
                        time: '2022-04-26T11:43:33.171Z',
                        holcombeGoal: true,
                        player: {
                            name: 'string',
                            number: 0,
                            teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                        },
                        gameId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                    }
                ]
            };
            holcombeScores.api.http.enqueueResponse([expectedGame]);

            await sut.getAllGames()
                .then(gamesList => {
                    expect(gamesList).not.toBeNull();
                    expect(gamesList.length).toBe(1);
                    let singleGame = gamesList[0];
                    expect(singleGame).toBe(expectedGame);
                });
        });

        it('getGame', async () => {
            let expectedGame = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                id: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                opponent: 'string',
                playingAtHome: true,
                date: '2022-04-26T11:43:33.171Z',
                squad: [
                    {
                        name: 'string',
                        number: 0,
                        teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                    }
                ],
                goals: [
                    {
                        time: '2022-04-26T11:43:33.171Z',
                        holcombeGoal: true,
                        player: {
                            name: 'string',
                            number: 0,
                            teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                        },
                        gameId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
                    }
                ]
            };
            holcombeScores.api.http.enqueueResponse(expectedGame);

            await sut.getGame('3fa85f64-5717-4562-b3fc-2c963f66afa6')
                .then(game => {
                    expect(game).not.toBeNull();
                    expect(game).toBe(expectedGame);
                });
        });

        it('deleteGame', async () => {
            let expectedGameId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            await sut.deleteGame(expectedGameId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Game/${expectedGameId}`);
                    expect(request.content).toBeNull();
                });
        });

        it('createGame', async () => {
            let expectedGame = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                date: '2022-04-26T11:54:53.719Z',
                opponent: 'string',
                playingAtHome: true,
                players: [
                    'name1', 'name2'
                ]
            };
            await sut.createGame(expectedGame.teamId, expectedGame.date, expectedGame.opponent, expectedGame.playingAtHome, expectedGame.players)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Game`);
                    expect(request.content).toMatchObject(expectedGame);
                });
        });

        it('updateGame', async () => {
            let expectedGameUpdate = {
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                date: '2022-04-26T11:53:10.195Z',
                opponent: 'string',
                playingAtHome: true,
                players: [
                    'name1', 'name2'
                ],
                id: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.updateGame(expectedGameUpdate.id, expectedGameUpdate.teamId, expectedGameUpdate.date, expectedGameUpdate.opponent, expectedGameUpdate.playingAtHome, expectedGameUpdate.players)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('PATCH');
                    expect(request.relativeUrl).toBe(`/api/Game`);
                    expect(request.content).toMatchObject(expectedGameUpdate);
                });
        });

        it('removePlayer', async () => {
            let expectedGameId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            let expectedPlayerNumber = 1;
            await sut.removePlayer(expectedGameId, expectedPlayerNumber)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Game/${expectedGameId}/${expectedPlayerNumber}`);
                    expect(request.content).toBeNull();
                });
        });

        it('removeGoal', async () => {
            let expectedGameId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            let expectedGoalId = '11111111-1111-1111-1111-111111111111';
            await sut.removeGoal(expectedGameId, expectedGoalId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Game/${expectedGameId}/${expectedGoalId}`);
                    expect(request.content).toBeNull();
                });
        });

        it('recordGoal', async () => {
            let expectedGoal = {
                time: '2022-04-26T11:52:03.802Z',
                holcombeGoal: true,
                player: {
                    number: 1
                },
                gameId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.recordGoal(expectedGoal.gameId, expectedGoal.time, expectedGoal.holcombeGoal, expectedGoal.player.number)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Game/Goal`);
                    expect(request.content).toMatchObject(expectedGoal);
                });
        });
    });

    describe('api.Player', () => {
        let sut = holcombeScores.api.player;

        beforeEach(() => {
            holcombeScores.api.http = new MockHttp(holcombeScores.api.settings);
        });

        it('getAllPlayers', async () => {
            let expectedPlayer = {
                name: 'string',
                number: 0,
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            holcombeScores.api.http.enqueueResponse([expectedPlayer]);

            await sut.getAllPlayers()
                .then(playersList => {
                    expect(playersList).not.toBeNull();
                    expect(playersList.length).toBe(1);
                    let singlePlayer = playersList[0];
                    expect(singlePlayer).toBe(expectedPlayer);
                });
        });

        it('updatePlayer', async () => {
            let expectedPlayerUpdate = {
                name: 'string',
                number: 1,
                teamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.updatePlayer(expectedPlayerUpdate.teamId, expectedPlayerUpdate.number, expectedPlayerUpdate.name)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('PUT');
                    expect(request.relativeUrl).toBe(`/api/Player`);
                    expect(request.content).toMatchObject(expectedPlayerUpdate);
                });
        });

        it('deletePlayer', async () => {
            let expectedTeamId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            let expectedNumber = 1;
            await sut.deletePlayer(expectedTeamId, expectedNumber)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Player/${expectedTeamId}/${expectedNumber}`);
                    expect(request.content).toBeNull();
                });
        });

        it('transferPlayer', async () => {
            let expectedTransfer = {
                currentNumber: 1,
                currentTeamId: '3fa85f64-5717-4562-b3fc-2c963f66afa6',
                newNumber: 2,
                newTeamId: '11111111-1111-1111-1111-111111111111'
            };
            await sut.transferPlayer(expectedTransfer.currentTeamId, expectedTransfer.currentNumber, expectedTransfer.newTeamId, expectedTransfer.newNumber)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Player/Transfer`);
                    expect(request.content).toMatchObject(expectedTransfer);
                });
        });
    });

    describe('api.Team', () => {
        let sut = holcombeScores.api.team;

        beforeEach(() => {
            holcombeScores.api.http = new MockHttp(holcombeScores.api.settings);
        });

        it('getAllTeams', async () => {
            let expectedTeam = {
                name: 'string',
                coach: 'string',
                id: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            holcombeScores.api.http.enqueueResponse([expectedTeam]);

            await sut.getAllTeams()
                .then(teamsList => {
                    expect(teamsList).not.toBeNull();
                    expect(teamsList.length).toBe(1);
                    let singleTeam = teamsList[0];
                    expect(singleTeam).toBe(expectedTeam);
                });
        });

        it('createTeam', async () => {
            let expectedTeamCreation = {
                name: 'string',
                coach: 'string'
            };
            await sut.createTeam(expectedTeamCreation.name, expectedTeamCreation.coach)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('POST');
                    expect(request.relativeUrl).toBe(`/api/Team`);
                    expect(request.content).toMatchObject(expectedTeamCreation);
                });
        });

        it('updateTeam', async () => {
            let expectedTeamUpdate = {
                name: 'string',
                coach: 'string',
                id: '3fa85f64-5717-4562-b3fc-2c963f66afa6'
            };
            await sut.updateTeam(expectedTeamUpdate.id, expectedTeamUpdate.name, expectedTeamUpdate.coach)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('PATCH');
                    expect(request.relativeUrl).toBe(`/api/Team`);
                    expect(request.content).toMatchObject(expectedTeamUpdate);
                });
        });

        it('deleteTeam', async () => {
            let expectedTeamId = '3fa85f64-5717-4562-b3fc-2c963f66afa6';
            await sut.deleteTeam(expectedTeamId)
                .then(_ => {
                    let request = holcombeScores.api.http.lastRequest();
                    expect(request).not.toBeNull();
                    expect(request.httpMethod).toBe('DELETE');
                    expect(request.relativeUrl).toBe(`/api/Team/${expectedTeamId}`);
                    expect(request.content).toBeNull();
                });
        });
    });

    prettify.toHTML(run(), document.body);
</script>
</body>
</html>